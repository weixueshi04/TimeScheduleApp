# TimeScheduleApp 迭代开发计划
**制定日期**: 2025-11-24
**预计完成时间**: 8小时
**开发模式**: 迭代开发，每个阶段验证后再进入下一阶段

---

## 总体目标

1. **统一代码版本** - 消除v1.0/v2.0混乱，使用Git进行版本管理
2. **采用迭代思维** - 先框架、再细节、再优化、最后UI
3. **质量优先** - 每个阶段都进行测试验证
4. **对标计划** - 按照APP开发计划完成所有需求

---

## 迭代规划概览

| 迭代 | 重点任务 | 预计时间 | 关键产出 |
|------|---------|---------|---------|
| **迭代1** | 代码结构统一 | 2-3小时 | 清洁的单一代码库 |
| **迭代2** | 核心功能UI | 3-4小时 | 自习室+任务管理可用 |
| **迭代3** | 稳定性增强 | 2小时 | Token刷新+WS重连 |
| **迭代4** | UI美化优化 | 1-2小时 | 流畅美观的界面 |
| **迭代5** | 验收文档 | 30分钟 | 部署就绪 |

---

## 迭代1: 代码结构清理和统一 (2-3小时)

### 目标
- 统一为单一v2.0版本
- 消除v1.0/v2.0的版本混乱
- 建立清晰的项目结构
- 确保项目可编译运行

### 任务清单

#### 1.1 项目结构重组 (45分钟)
- [ ] 创建备份分支 `backup/v1.0-and-v2.0-original`
- [ ] 归档v1.0代码到 `archive/v1.0/` 目录
- [ ] 将 `app_v2/lib` 代码移动到根目录 `lib/`
- [ ] 删除 `app_v2` 目录
- [ ] 清理重复的文档文件

**新的项目结构**:
```
TimeScheduleApp/
├── lib/                          # Flutter客户端代码（v2.0）
│   ├── main.dart
│   ├── data/
│   │   ├── models/              # 数据模型
│   │   ├── repositories/        # 数据仓库
│   │   └── services/            # API/WebSocket服务
│   ├── business/
│   │   └── providers/           # 状态管理
│   └── presentation/
│       ├── screens/             # UI页面
│       └── widgets/             # UI组件
├── server/                       # Node.js后端
├── test/                         # 测试文件
├── android/                      # Android平台
├── ios/                         # iOS平台
├── archive/                      # 归档的旧代码
│   └── v1.0/                    # v1.0单机版（归档）
└── docs/                        # 统一的文档目录
```

#### 1.2 依赖整合 (30分钟)
- [ ] 合并v1.0和v2.0的 `pubspec.yaml`
- [ ] 升级关键依赖到最新版本
  - provider: 6.1.1 → 6.2.1
  - flutter_secure_storage: 9.0.0 → 9.2.2
  - logger: 2.0.2+1 → 2.4.0
- [ ] 添加必要的新依赖
  - cached_network_image: ^3.3.1
  - shimmer: ^3.0.0 (加载骨架屏)
- [ ] 运行 `flutter pub get`

**最终的pubspec.yaml**:
```yaml
name: timeschedule_app
description: TimeScheduleApp - 有温度的网络自习室
version: 2.0.0+1

environment:
  sdk: '>=3.0.0 <4.0.0'

dependencies:
  flutter:
    sdk: flutter

  # 状态管理
  provider: ^6.2.1

  # 网络请求
  dio: ^5.4.0
  socket_io_client: ^2.0.3+1

  # 本地存储
  shared_preferences: ^2.2.2
  flutter_secure_storage: ^9.2.2

  # UI组件
  cupertino_icons: ^1.0.6
  flutter_svg: ^2.0.9
  cached_network_image: ^3.3.1
  shimmer: ^3.0.0

  # 工具类
  intl: ^0.19.0
  uuid: ^4.3.3
  logger: ^2.4.0

  # 数据模型
  json_annotation: ^4.9.0
  equatable: ^2.0.5

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^3.0.1
  build_runner: ^2.4.7
  json_serializable: ^6.8.0

flutter:
  uses-material-design: true
  assets:
    - assets/images/
    - assets/icons/
```

#### 1.3 代码适配和编译 (45分钟)
- [ ] 更新所有import路径（app_v2/lib → lib）
- [ ] 修复导入错误
- [ ] 运行 `flutter analyze` 检查代码问题
- [ ] 修复所有编译错误
- [ ] 确保 `flutter run` 可以启动应用

#### 1.4 Git版本管理 (30分钟)
- [ ] 提交代码结构重组
  ```bash
  git add .
  git commit -m "refactor: 统一为v2.0版本，归档v1.0代码"
  ```
- [ ] 更新README.md，说明新的项目结构
- [ ] 删除过时的文档，整理到docs目录

### 验收标准
✅ 项目只有一个lib目录，没有v1.0/v2.0混乱
✅ `flutter analyze` 无错误
✅ `flutter run` 可以启动应用
✅ 所有依赖升级完成
✅ Git提交记录清晰

### 测试重点
- 应用能否正常启动
- 登录功能是否正常
- API连接是否正常

---

## 迭代2: 核心功能UI完善 (3-4小时)

### 目标
- 完成网络自习室完整UI
- 完成任务管理完整UI
- 实现端到端的功能流程
- 编写关键功能的单元测试

### 任务清单

#### 2.1 自习室功能完善 (2小时)

##### 2.1.1 自习室列表页 (40分钟)
- [ ] 创建 `lib/presentation/screens/study_room/study_room_list_screen.dart`
- [ ] 实现自习室列表UI
  - 下拉刷新
  - 加载状态（Shimmer骨架屏）
  - 空状态提示
- [ ] 实现筛选功能（按状态、类型）
- [ ] 实现搜索功能

##### 2.1.2 创建自习室页 (30分钟)
- [ ] 创建 `lib/presentation/screens/study_room/create_study_room_screen.dart`
- [ ] 实现表单UI
  - 自习室名称
  - 任务类型选择
  - 时长设置
  - 人数上限
- [ ] 表单验证
- [ ] 提交创建

##### 2.1.3 自习室详情页 (50分钟)
- [ ] 创建 `lib/presentation/screens/study_room/study_room_detail_screen.dart`
- [ ] 实现自习室信息展示
  - 房间信息卡片
  - 参与者列表（实时更新）
  - 能量条显示（进度条+数值）
  - 倒计时显示
- [ ] 实现操作按钮
  - 加入/离开自习室
  - 开始专注
  - 分享
- [ ] WebSocket实时更新
  - 监听用户加入/离开
  - 监听能量条变化

#### 2.2 任务管理功能完善 (1小时)

##### 2.2.1 任务列表页 (30分钟)
- [ ] 创建 `lib/presentation/screens/tasks/task_list_screen.dart`
- [ ] 实现任务列表UI
  - 今日任务视图
  - 全部任务视图
  - 分类标签
- [ ] 实现任务状态切换
  - 标记完成
  - 删除确认
- [ ] 实现滑动操作
  - 左滑删除
  - 右滑完成

##### 2.2.2 创建/编辑任务页 (30分钟)
- [ ] 创建 `lib/presentation/screens/tasks/task_form_screen.dart`
- [ ] 实现任务表单
  - 任务标题
  - 任务描述
  - 优先级选择
  - 截止日期
  - 番茄钟估算
- [ ] 表单验证
- [ ] 保存任务

#### 2.3 专注计时功能 (45分钟)
- [ ] 创建 `lib/presentation/screens/focus/focus_timer_screen.dart`
- [ ] 实现番茄钟UI
  - 圆形进度条
  - 倒计时显示
  - 开始/暂停/停止按钮
- [ ] 实现计时逻辑
  - 倒计时Timer
  - 后台保持计时
- [ ] 完成后保存记录

#### 2.4 通用组件库 (30分钟)
- [ ] 创建 `lib/presentation/widgets/common/` 目录
- [ ] 实现通用组件
  - `AppButton` - 统一按钮样式
  - `AppTextField` - 统一输入框样式
  - `LoadingOverlay` - 加载遮罩
  - `EmptyState` - 空状态组件
  - `ErrorWidget` - 错误提示组件

### 验收标准
✅ 所有主要功能页面完成
✅ UI符合设计规范
✅ 功能流程可以走通
✅ WebSocket实时更新正常

### 测试重点
- 创建自习室 → 加入 → 离开流程
- 创建任务 → 编辑 → 完成流程
- 专注计时功能

---

## 迭代3: 稳定性和性能增强 (2小时)

### 目标
- 实现Token自动刷新
- 实现WebSocket心跳和自动重连
- 完善错误处理
- 提高应用稳定性

### 任务清单

#### 3.1 Token自动刷新 (1小时)
- [ ] 增强 `TokenService`
  - 添加Token过期检测
  - 实现自动刷新机制
  - 实现主动刷新（过期前5分钟）
- [ ] 改进 `ApiClient` 拦截器
  - 处理401错误
  - 处理并发请求的Token刷新
  - 自动重试失败的请求
- [ ] 添加登出处理
  - Token失效自动跳转登录页
  - 清除所有本地数据

#### 3.2 WebSocket稳定性 (45分钟)
- [ ] 增强 `WebSocketService`
  - 实现心跳检测（30秒ping/pong）
  - 实现自动重连（指数退避）
  - 处理断网场景
  - 连接状态可视化
- [ ] 添加WebSocket事件监听
  - 连接成功提示
  - 断开连接提示
  - 重连中提示

#### 3.3 错误处理完善 (15分钟)
- [ ] 统一错误处理
  - 网络错误
  - 服务器错误
  - 业务错误
- [ ] 友好的错误提示
  - Toast提示
  - 错误页面
  - 重试按钮

### 验收标准
✅ Token自动刷新工作正常
✅ WebSocket自动重连成功
✅ 各种异常场景都有友好提示

### 测试重点
- 模拟Token过期场景
- 模拟网络断开场景
- 模拟服务器错误场景

---

## 迭代4: UI美化和体验优化 (1-2小时)

### 目标
- 优化UI细节
- 添加动画效果
- 性能优化
- 提升用户体验

### 任务清单

#### 4.1 UI细节优化 (30分钟)
- [ ] 统一颜色和字体
- [ ] 优化间距和布局
- [ ] 添加阴影和圆角
- [ ] 优化图标和图片

#### 4.2 动画效果 (30分钟)
- [ ] 页面切换动画
- [ ] 列表项动画
- [ ] 按钮点击反馈
- [ ] 加载动画

#### 4.3 性能优化 (30分钟)
- [ ] 使用Selector优化Provider
- [ ] 使用const优化Widget
- [ ] 图片缓存优化
- [ ] 列表性能优化

#### 4.4 用户体验优化 (30分钟)
- [ ] 添加引导页
- [ ] 添加空状态插画
- [ ] 优化加载状态
- [ ] 添加haptic反馈

### 验收标准
✅ UI美观统一
✅ 动画流畅自然
✅ 列表滚动FPS > 50
✅ 内存占用合理

### 测试重点
- 滚动性能测试
- 内存占用测试
- 用户体验测试

---

## 迭代5: 最终验收和文档 (30分钟)

### 目标
- 完整的功能验收
- 完善项目文档
- 准备部署

### 任务清单

#### 5.1 功能验收 (15分钟)
- [ ] 核对APP开发计划的所有需求
- [ ] 测试所有核心功能流程
- [ ] 修复发现的bug

#### 5.2 文档完善 (10分钟)
- [ ] 更新README.md
- [ ] 编写部署文档
- [ ] 编写用户手册

#### 5.3 代码提交 (5分钟)
- [ ] 最终代码review
- [ ] Git提交
- [ ] 推送到远程仓库

### 验收标准
✅ 所有功能正常工作
✅ 文档完善
✅ 代码已推送

---

## 开发原则

### 代码质量
1. **模块化**: 每个功能独立模块
2. **可测试**: 关键逻辑可单元测试
3. **可维护**: 代码清晰易读
4. **可扩展**: 便于后续功能添加

### 测试策略
1. **单元测试**: 测试业务逻辑
2. **Widget测试**: 测试UI组件
3. **集成测试**: 测试完整流程
4. **手动测试**: 测试用户体验

### Git提交规范
```
feat: 新功能
fix: Bug修复
refactor: 重构
docs: 文档更新
style: 代码格式
test: 测试相关
chore: 构建工具相关
```

---

## 风险预警

| 风险 | 概率 | 影响 | 应对措施 |
|-----|------|------|---------|
| 依赖升级导致破坏性变化 | 中 | 高 | 仔细查看changelog，逐步升级 |
| WebSocket连接不稳定 | 高 | 中 | 实现完善的重连机制 |
| 性能问题 | 中 | 中 | 使用Selector和const优化 |
| 测试覆盖不足 | 高 | 低 | 至少覆盖核心功能 |

---

## 成功指标

### 功能完整性
- [ ] 用户认证系统 100%
- [ ] 网络自习室 100%
- [ ] 任务管理 100%
- [ ] 专注计时 100%
- [ ] 健康管理 80% (保留v1.0功能)

### 代码质量
- [ ] 代码重复率 < 20%
- [ ] 编译无警告
- [ ] 关键功能有测试

### 性能指标
- [ ] 应用启动时间 < 2秒
- [ ] 列表滚动FPS > 50
- [ ] API响应时间 < 500ms

### 稳定性
- [ ] WebSocket连接成功率 > 95%
- [ ] Token自动刷新成功率 > 99%
- [ ] 应用无崩溃

---

## 下一步行动

**立即开始**: 迭代1 - 代码结构清理
**预计时长**: 2-3小时
**关键任务**: 统一代码版本，消除混乱

让我们开始吧！ 🚀
